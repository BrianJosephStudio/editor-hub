name: Deploy to Production and Development

on:
  push:
    branches:
      - main
      - dev
    workflow_dispatch:

env:
  SERVER_CONTAINER_NAME: editor-hub-${GITHUB_REF##*/}
  AUTH_CONTAINER_NAME: authorization-${GITHUB_REF##*/}
  CLIP_TAGGER_CONTAINER_NAME: clip-tagger-${GITHUB_REF##*/}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3


    - name: Set up SSH
      uses: appleboy/ssh-action@v1.2.0
      with:
        host: ${{ secrets.EDITOR_HUB_HOST }}
        username: ${{ secrets.EDITOR_HUB_USER }}
        key: ${{ secrets.EDITOR_HUB_KEY }}
        script: |
          pwd
          if [ "${GITHUB_REF##*/}" == "main" ]; then
            echo "Deploying to Production..."
            DEPLOY_FOLDER="${{ secrets.EDITOR_HUB_PRODUCTION_DIR }}"
          else
            echo "Deploying to Development..."
            DEPLOY_FOLDER="${{ secrets.EDITOR_HUB_DEV_DIR }}"
          fi
          export NVM_DIR=~/.nvm
          source ~/.nvm/nvm.sh
          echo ${SERVER_CONTAINER_NAME}
          cd $DEPLOY_FOLDER
          npm run deploy
